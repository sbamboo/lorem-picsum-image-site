<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorem Picsum Random Image</title>
    <link rel="stylesheet" href="./index.css">
</head>
<body>

<div id="imageInfo">
    <p>Current Seed: <span id="currentSeed"></span></p>
    <label for="customSeed">Custom Seed:</label>
    <input type="text" id="customSeed" placeholder="Enter custom seed">
    <p>Click to view the image on Lorem Picsum: <a id="imageLink" href="#" target="_blank">View Image</a></p>
    
    <div id="customSizeFields">
        <label for="customWidth">Custom Width:</label>
        <input type="number" id="customWidth" placeholder="Width">
        <label for="customHeight">Custom Height:</label>
        <input type="number" id="customHeight" placeholder="Height">
    </div>
    
    <button id="reloadButton">Reload Image</button>
</div>

<div id="infoContainer">
    <div id="infoIcon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
        </svg>
    </div>
    <div id="infoText">
        <p>Page made by SimonKC 2023-11-21</p>
        <p>Generated by ChatGPT 3.5</p>
    </div>
</div>

<script>
    // Function to generate a random seed and fetch the corresponding image from Lorem Picsum
    function getRandomImage(seed, width, height) {
        // If width and height are provided, use them; otherwise, use document size
        const resolution = (width && height) ? `${width}/${height}` : '1920/1080';

        // If a custom seed is provided, use it; otherwise, generate a random seed
        const randomSeed = seed || Math.floor(Math.random() * 1000);

        // Set the current seed in the HTML
        document.getElementById('currentSeed').innerText = randomSeed;

        // Use the seed and resolution to fetch the image
        const imageUrl = `https://picsum.photos/seed/${randomSeed}/${resolution}`;

        // Set background image
        document.body.style.backgroundImage = `url(${imageUrl})`;

        // Update the link to view the image on Lorem Picsum
        document.getElementById('imageLink').href = `https://picsum.photos/seed/${randomSeed}/${resolution}`;

        // Get the average color of the image
        getAverageColor(imageUrl);
    }

    // Function to set the background color based on the "color" URL parameter
    function setBackgroundColorFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const colorFromURL = urlParams.get('color');

        if (colorFromURL) {
            const isValidColor = /^([0-9A-Fa-f]{6})$/g.test(colorFromURL);

            if (isValidColor) {
                document.body.style.backgroundColor = `#${colorFromURL}`;
            }
        }
    }

    // Function to get the average color of the image
    function getAverageColor(imageUrl) {
        const img = new Image();
        img.crossOrigin = 'Anonymous';

        img.onload = function () {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;

            ctx.drawImage(img, 0, 0, img.width, img.height);

            // Get image data
            const imageData = ctx.getImageData(0, 0, img.width, img.height).data;

            // Calculate average color
            let sumRed = 0;
            let sumGreen = 0;
            let sumBlue = 0;

            for (let i = 0; i < imageData.length; i += 4) {
                sumRed += imageData[i];
                sumGreen += imageData[i + 1];
                sumBlue += imageData[i + 2];
            }

            const avgRed = Math.round(sumRed / (imageData.length / 4));
            const avgGreen = Math.round(sumGreen / (imageData.length / 4));
            const avgBlue = Math.round(sumBlue / (imageData.length / 4));

            // Set the color URL parameter
            const avgColor = rgbToHex(avgRed, avgGreen, avgBlue);

            // Create a URLSearchParams object for the existing URL parameters
            const urlParams = new URLSearchParams(window.location.search);

            // Set the color parameter to the avgColor value
            urlParams.set('color', avgColor);

            // Replace the current URL with the updated URL parameters
            history.replaceState({}, '', `?${urlParams.toString()}`);
        };

        img.src = imageUrl;
    }

    // RGB to Hex conversion function
    function rgbToHex(r, g, b) {
        const toHex = (c) => ('0' + c.toString(16)).slice(-2);
        return toHex(r) + toHex(g) + toHex(b);
    }

    // Call the function to set the background color based on the "color" URL parameter
    setBackgroundColorFromURL();

    // Parse the width and height from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const widthFromURL = urlParams.get('width');
    const heightFromURL = urlParams.get('height');

    // Call the function with the initial random seed and specified resolution when the page loads
    getRandomImage(null, widthFromURL, heightFromURL);

    // Add click event listener to the reload button
    document.getElementById('reloadButton').addEventListener('click', function () {
        // Get the value of the custom seed input
        const customSeed = document.getElementById('customSeed').value.trim();
        const customWidth = document.getElementById('customWidth').value.trim();
        const customHeight = document.getElementById('customHeight').value.trim();

        // Create a URLSearchParams object for the existing URL parameters
        const urlParams = new URLSearchParams(window.location.search);

        // Set the seed, width, and height parameters to the respective input values (or empty strings if not provided)
        urlParams.set('seed', customSeed);
        urlParams.set('width', customWidth);
        urlParams.set('height', customHeight);

        // Replace the current URL with the updated URL parameters
        history.replaceState({}, '', `?${urlParams.toString()}`);
        
        // Reload the page
        location.reload();
    });

    // Parse the seed from the URL and reload the page with the specified seed if present
    const seedFromURL = urlParams.get('seed');
    if (seedFromURL) {
        document.getElementById('customSeed').value = seedFromURL;
        getRandomImage(seedFromURL, widthFromURL, heightFromURL);
    }

    // Parse the width and height from the URL and update the custom size fields
    document.getElementById('customWidth').value = widthFromURL || '';
    document.getElementById('customHeight').value = heightFromURL || '';
</script>

</body>
</html>
